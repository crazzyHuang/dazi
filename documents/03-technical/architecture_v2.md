# 同频搭子 - 技术架构文档 (V2.0)

**版本：2.0**
**关联PRD版本：V3.0**

## 1. 概述

本文档旨在定义“同频搭子”App的整体技术架构、组件划分和技术选型，以指导后续的开发、测试和部署工作。架构设计的核心目标是：**高可用性、高扩展性、可维护性、安全性和成本效益**。

## 2. 架构原则

- **前后端分离**：客户端（移动端）与服务端彻底分离，通过API进行通信，便于独立开发、测试和部署。
- **微服务导向**：在业务初期采用“聚合服务”或“大单体”模式快速迭代，但架构设计上为未来向微服务平滑演进预留接口和能力。
- **无状态服务**：后端应用服务本身不存储状态，以便于水平扩展和负载均衡。
- **数据驱动**：技术选型和架构决策应有利于数据的收集与分析，特别是为“灵魂回响”等智能功能提供支持。

## 3. 技术选型 (推荐)

| 领域       | 技术/框架         | 理由                                                                                                             |
| :--------- | :---------------- | :--------------------------------------------------------------------------------------------------------------- |
| **前端**   | **React Native**  | - **跨平台**：一套代码库同时构建iOS和Android应用，极大降低开发和维护成本。<br>- **生态成熟**：拥有庞大的社区和丰富的第三方库，能快速实现复杂功能。<br>- **性能优异**：接近原生性能，能满足社交应用对流畅度的要求。                                   |
| **后端**   | **Node.js (NestJS)** | - **高性能I/O**：基于事件驱动的非阻塞I/O模型，非常适合处理社交应用中的大量并发连接（如聊天、通知）。<br>- **TypeScript支持**：NestJS框架原生支持TypeScript，提供强大的类型系统和可维护的架构。<br>- **开发效率**：与前端使用同一种语言（JavaScript/TypeScript），便于团队协作和全栈开发。 |
| **数据库** | **PostgreSQL**    | - **功能强大**：业界领先的开源关系型数据库，支持复杂的查询和事务，数据一致性强。<br>- **扩展性好**：支持JSONB等非结构化数据，能灵活存储用户画像、搭子邀约等复杂信息。<br>- **稳定可靠**：经过长期和大规模的生产环境验证。                                               |
| **缓存**   | **Redis**         | - **高性能**：基于内存的键值存储，读写速度极快。<br>- **多功能**：用于缓存热门数据（如搭子广场帖子）、用户Session、实现消息队列等。                               |
| **实时通信**| **WebSocket (Socket.IO)** | - **双向通信**：为App内的即时聊天、实时通知（如回响解锁）等功能提供低延迟、可靠的通信支持。Socket.IO提供了良好的封装和降级方案。 |
| **搜索引擎**| **Elasticsearch** | - **全文搜索**：为“搭子广场”提供强大的模糊搜索、关键词高亮等功能。<br>- **数据分析**：未来可用于分析用户行为日志，为推荐算法提供数据支持。                                   |
| **对象存储**| **AWS S3 / 阿里云 OSS** | - **海量存储**：用于存储用户上传的图片、头像等静态资源。<br>- **高可用、低成本**：提供高可靠性的存储服务，并可通过CDN加速全球访问。                                     |

## 4. 系统架构图

```mermaid
graph TD
    subgraph 用户端 (Client)
        A[移动App (React Native)]
    end

    subgraph 网络层
        B[API网关 (API Gateway)]
        C[CDN / 负载均衡 (Load Balancer)]
    end

    subgraph 服务端 (Backend)
        D[主应用服务 (Node.js/NestJS)]
        E[实时通信服务 (WebSocket)]
    end

    subgraph 数据与存储层 (Data & Storage)
        F[PostgreSQL数据库]
        G[Redis缓存]
        H[Elasticsearch搜索引擎]
        I[对象存储 (S3/OSS)]
    end

    subgraph 第三方服务
        J[推送服务 (APNs/FCM)]
        K[短信/验证码服务]
    end

    A --> C --> B
    B --> D
    A -- WebSocket连接 --> E
    D --> F
    D --> G
    D --> H
    D --> I
    D --> J
    D --> K
```

**架构解读**：
1.  用户通过React Native开发的App与系统交互。
2.  所有HTTP请求首先经过CDN和负载均衡，然后到达API网关。
3.  API网关将请求路由到后端的**主应用服务**。该服务是核心业务逻辑的承载者。
4.  需要实时通信的场景（如聊天），App会与**实时通信服务**建立独立的WebSocket长连接。
5.  主应用服务在处理业务逻辑时，会与**PostgreSQL**、**Redis**、**Elasticsearch**和**对象存储**进行交互，完成数据的增删改查。
6.  需要发送推送和短信时，主应用服务会调用相应的**第三方服务**。

## 5. 部署策略

- **容器化**：所有后端服务（主应用、实时通信服务等）都将被打包成**Docker**镜像，实现环境的标准化和隔离。
- **容器编排**：使用**Kubernetes (K8s)** 或云厂商提供的容器服务（如AWS ECS, Google GKE）来管理和编排容器，实现自动扩缩容、故障自愈和滚动更新。
- **CI/CD**：建立持续集成/持续部署流水线（如使用GitLab CI, Jenkins），实现代码提交后自动化的测试、构建和部署，提升交付效率和质量。

## 6. 下一步

基于本架构文档，下一步应进行：
1.  **数据库详细设计**：设计核心业务的数据表结构。
2.  **核心API接口定义**：定义客户端与服务端之间的通信契约。
